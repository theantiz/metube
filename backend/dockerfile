# ============================
# Stage 1 — Build Spring Boot
# ============================
FROM eclipse-temurin:17-jdk AS build
WORKDIR /app

COPY mvnw .
COPY .mvn .mvn
COPY pom.xml .

RUN chmod +x mvnw
RUN ./mvnw -q -ntp dependency:go-offline

COPY src src
RUN ./mvnw -q -ntp package -DskipTests


# ============================
# Stage 2 — Prepare yt-dlp + ffmpeg + node
# ============================
FROM debian:bookworm-slim AS tools
WORKDIR /tools

RUN apt-get update && apt-get install -y \
    ffmpeg \
    curl \
    ca-certificates \
    xz-utils \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

RUN curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp \
    -o /usr/local/bin/yt-dlp && chmod a+rx /usr/local/bin/yt-dlp

RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*


# ============================
# Stage 3 — Ultra-Light Final Image
# ============================
FROM gcr.io/distroless/java17-debian12:nonroot
WORKDIR /app

COPY --from=tools /usr/local/bin/yt-dlp /usr/local/bin/yt-dlp
COPY --from=tools /usr/bin/ffmpeg /usr/bin/ffmpeg
COPY --from=tools /usr/bin/node /usr/bin/node
COPY --from=tools /usr/lib/node_modules /usr/lib/node_modules

COPY --from=build /app/target/*.jar app.jar

EXPOSE 8080
USER nonroot
ENTRYPOINT ["java", "-jar", "app.jar"]

